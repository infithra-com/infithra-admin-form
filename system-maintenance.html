<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Maintenance</title>
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1112.0.min.js"></script>
    <!-- Include Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/script.js"></script>

    <style>
        .loader {
            display: none;
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .maintenance-card {
            transition: all 0.3s ease;
        }

        .maintenance-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-scheduled {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-ongoing {
            background-color: #cce5ff;
            color: #004085;
        }

        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }
    </style>
</head>

<body class="bg-body-secondary">
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-md mb-4">
        <div class="container">
            <a class="navbar-brand font-bold text-xl" href="#">Infitra Admin</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link text-lg hover:text-blue-600" href="company.html">Company Information</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-lg hover:text-blue-600" href="system-control.html">System Control</a>
                    </li>
                    <!-- <li class="nav-item">
                        <a class="nav-link text-lg hover:text-blue-600" href="subscription-creator.html">Subscription Creator</a>
                    </li> -->
                    <li class="nav-item">
                        <a class="nav-link text-lg hover:text-blue-600 active" href="system-maintenance.html">System Maintenance</a>
                    </li>
                    <button class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-200 ease-in-out cursor-pointer" onclick="logout()">Logout</a>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-5">
        <h1 class="fs-2 fw-bold mb-5 text-center">System Maintenance</h1>

        <!-- Current Maintenance Section -->
        <div class="card mb-5">
            <div class="card-header bg-primary text-white">
                <h2 class="card-title mb-0">Current Maintenance</h2>
            </div>
            <div class="card-body">
                <div id="currentMaintenance" class="row">
                    <!-- Will be populated by JavaScript -->
                    <div class="col-12 text-center py-4">
                        <div class="loader mx-auto" id="currentLoader"></div>
                        <p class="text-muted mt-3" id="currentMessage">Loading current maintenance...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Maintenance Section -->
        <div class="card mb-5">
            <div class="card-header bg-success text-white" id="maintenanceFormHeader">
                <h2 class="card-title mb-0">Schedule New Maintenance</h2>
            </div>
            <div class="card-body">
                <form id="maintenanceForm" onsubmit="submitMaintenanceForm(event)">
                    <input type="hidden" id="maintenanceId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="title" class="form-label">Title *</label>
                            <input type="text" class="form-control" id="title" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="category" class="form-label">Category *</label>
                            <select class="form-control" id="category" required>
                                <option value="">Select Category</option>
                                    <option value="System Upgrade">System Upgrade</option>
                                    <option value="Server Maintenance">Server Maintenance</option>
                                    <option value="Database Maintenance">Database Maintenance</option>
                                    <option value="Network Maintenance">Network Maintenance</option>
                                    <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="description" class="form-label">Description *</label>
                            <textarea class="form-control" id="description" rows="3" required></textarea>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="date" class="form-label">Date *</label>
                            <input type="date" class="form-control" id="date" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="startTime" class="form-label">Start Time *</label>
                            <input type="time" class="form-control" id="startTime" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="endTime" class="form-label">End Time *</label>
                            <input type="time" class="form-control" id="endTime" required>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="targetAccounts" class="form-label">Target Accounts (comma separated) *</label>
                            <input type="text" class="form-control" id="targetAccounts" placeholder="6666666,5555555 or * for all" required>
                            <small class="text-muted">Enter account numbers separated by commas or * for all accounts</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="status" class="form-label">Status *</label>
                            <select class="form-control" id="status" required>
                                <option value="Scheduled">Scheduled</option>
                                <option value="Ongoing">Ongoing</option>
                                <option value="Completed">Completed</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-secondary" onclick="resetMaintenanceForm()">Reset</button>
                        <button type="submit" class="btn btn-primary" id="submitMaintenanceBtn">
                            <span id="submitLoader" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            Submit Maintenance
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Maintenance History Section -->
        <div class="card">
            <div class="card-header bg-info text-white">
                <h2 class="card-title mb-0">Maintenance History</h2>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-3 mb-3">
                        <label for="historytargetAccountsFilter" class="form-label">Target Accounts</label>
                        <input type="text" class="form-control" id="historytargetAccountsFilter" placeholder="6666666,5555555 or * for all">
                        <small class="text-muted">Account numbers separated by commas</small>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="historydateFilter" class="form-label">Date</label>
                        <input type="date" class="form-control" id="historydateFilter">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="historyStatusFilter" class="form-label">Status</label>
                        <select class="form-control" id="historyStatusFilter">
                            <option value="">All Statuses</option>
                            <option value="Scheduled">Scheduled</option>
                            <option value="Ongoing">Ongoing</option>
                            <option value="Completed">Completed</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-center mb-3">
                        <button class="btn btn-primary w-50" onclick="loadMaintenanceHistory()">
                            <i class="fas fa-filter me-2"></i>Filter
                        </button>
                    </div>
                </div>
                <div id="maintenanceHistory" class="row">
                    <div class="col-12 text-center py-4">
                        <div class="loader mx-auto" id="historyLoader"></div>
                        <p class="text-muted mt-3" id="historyMessage">Loading maintenance history...</p>
                    </div>
                </div>
                <div class="d-flex justify-content-center mt-4">
                    <nav aria-label="Page navigation">
                        <ul class="pagination" id="pagination">
                            <!-- Pagination will be added here by JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Maintenance Details Modal -->
    <div class="modal fade" id="maintenanceDetailsModal" tabindex="-1" aria-labelledby="maintenanceDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="maintenanceDetailsModalLabel">Maintenance Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="maintenanceDetailsContent">
                    <!-- Content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="editMaintenanceBtn" onclick="editMaintenance()">Edit</button>
                </div>
            </div>
        </div>
    </div>

<script>

        // Global variables
        let currentPage = 1;
        const itemsPerPage = 5;
        let totalMaintenanceItems = 0;

        // DOM elements
        const currentLoader = document.getElementById('currentLoader');
        const currentMessage = document.getElementById('currentMessage');
        const submitLoader = document.getElementById('submitLoader');
        const submitMaintenanceBtn = document.getElementById('submitMaintenanceBtn');
        const historyLoader = document.getElementById('historyLoader');
        const historyMessage = document.getElementById('historyMessage');

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadCurrentMaintenance();
            loadMaintenanceHistory();

            // Set default date to today and time to next hour
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const nextHour = new Date(now.getTime() + 60 * 60 * 1000);
            const startTime = `${String(nextHour.getHours()).padStart(2, '0')}:${String(nextHour.getMinutes()).padStart(2, '0')}`;
            const endTime = `${String(nextHour.getHours() + 1).padStart(2, '0')}:${String(nextHour.getMinutes()).padStart(2, '0')}`;

            document.getElementById('date').value = today;
            document.getElementById('startTime').value = startTime;
            document.getElementById('endTime').value = endTime;
        });

        // Load current maintenance (Scheduled or Ongoing)
        function loadCurrentMaintenance() {
            console.log('Loading current maintenance...');
            currentLoader.style.display = 'block';
            currentMessage.textContent = 'Loading current maintenance...';
            document.getElementById('currentMaintenance').innerHTML = '';

            fetch(`${apiURL}/system/client/system_maintenance?accounts=*`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${cognitoToken}`,
                    'x-origin-ip': originIP,
                    'x-otp': otp,
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                currentLoader.style.display = 'none';

                if (data.data) {
                    currentMessage.textContent = '';
                    renderCurrentMaintenance(data.data);
                } else {
                    currentMessage.textContent = 'No current maintenance scheduled.';
                }
            })
            .catch(error => {
                currentLoader.style.display = 'none';
                currentMessage.textContent = 'Error loading current maintenance.';
                console.error('Error:', error);
            });
        }

        // Render current maintenance card
        function renderCurrentMaintenance(maintenance) {
            const currentMaintenanceDiv = document.getElementById('currentMaintenance');

            const statusClass = maintenance.status === 'Scheduled' ? 'status-scheduled' :
                              maintenance.status === 'Ongoing' ? 'status-ongoing' : 'status-completed';

            const startTime = new Date(maintenance.startTime).toLocaleString();
            const endTime = new Date(maintenance.endTime).toLocaleString();
            const formattedDate = new Date(maintenance.date).toLocaleDateString();

            const cardHtml = `
                <div class="col-12">
                    <div class="card maintenance-card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h3 class="card-title mb-0">${maintenance.title}</h3>
                            <span class="status-badge ${statusClass}">${maintenance.status}</span>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Category:</strong> ${maintenance.category}</p>
                                    <p><strong>Description:</strong> ${maintenance.description}</p>
                                    <p><strong>Date:</strong> ${formattedDate}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Start Time:</strong> ${startTime}</p>
                                    <p><strong>End Time:</strong> ${endTime}</p>
                                    <p><strong>Target Accounts:</strong> ${maintenance.targetAccounts.join(', ')}</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer d-flex justify-content-end">
                            <button class="btn btn-sm btn-info me-2" onclick="viewMaintenanceDetails(${maintenance.id})">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                            <button class="btn btn-sm btn-warning me-2" onclick="editMaintenanceForm(${maintenance.id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            ${(maintenance.status === 'Ongoing' || maintenance.status === 'Scheduled') ? `
                        <button class="btn btn-sm btn-success" onclick="completeMaintenance(${maintenance.id})">
                            <i class="fas fa-check"></i> Complete
                        </button>
                    ` : ''}
                        </div>
                    </div>
                </div>
            `;

            currentMaintenanceDiv.innerHTML = cardHtml;
        }

        // Load maintenance history with pagination
        function loadMaintenanceHistory(page = 1) {
        currentPage = page;
        historyLoader.style.display = 'block';
        historyMessage.textContent = 'Loading maintenance history...';
        document.getElementById('maintenanceHistory').innerHTML = '';
        document.getElementById('pagination').innerHTML = '';

        // Get filter values
        const accountsFilter = document.getElementById('historytargetAccountsFilter').value;
        const dateFilter = document.getElementById('historydateFilter').value;
        const statusFilter = document.getElementById('historyStatusFilter').value;

        // Build query parameters
        let queryParams = `page=${page}&limit=${itemsPerPage}`;

        if (accountsFilter) {
            queryParams += `&accounts=${encodeURIComponent(accountsFilter)}`;
        }

        if (dateFilter) {
            queryParams += `&date=${encodeURIComponent(dateFilter)}`;
        }

        if (statusFilter) {
            queryParams += `&status=${encodeURIComponent(statusFilter)}`;
        }

        fetch(`${apiURL}/system/client/system_maintenance/history?${queryParams}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${cognitoToken}`,
                'x-origin-ip': originIP,
                'x-otp': otp,
"x-compression": false,
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            historyLoader.style.display = 'none';

            if (data.data && data.data.length > 0) {
                historyMessage.textContent = '';
                totalMaintenanceItems = data.total || data.data.length;
                renderMaintenanceHistory(data.data);
                renderPagination();
            } else {
                historyMessage.textContent = 'No maintenance history found.';
            }
        })
        .catch(error => {
            historyLoader.style.display = 'none';
            historyMessage.textContent = 'Error loading maintenance history.';
            console.error('Error:', error);
        });
}
// Render maintenance history cards
function renderMaintenanceHistory(maintenanceList) {
    const historyDiv = document.getElementById('maintenanceHistory');

    maintenanceList.forEach(maintenance => {
        const statusClass = maintenance.status === 'Scheduled' ? 'status-scheduled' :
                          maintenance.status === 'Ongoing' ? 'status-ongoing' :
                          maintenance.status === 'Completed' ? 'status-completed' : 'status-scheduled';

        const startTime = new Date(maintenance.startTime).toLocaleString();
        const endTime = new Date(maintenance.endTime).toLocaleString();
        const actualEndTime = maintenance.actualEndTime ? new Date(maintenance.actualEndTime).toLocaleString() : 'N/A';
        const formattedDate = new Date(maintenance.date).toLocaleDateString();

        const cardHtml = `
            <div class="col-12 mb-3">
                <div class="card maintenance-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="card-title mb-0">${maintenance.title}</h4>
                        <div>
                            <span class="status-badge ${statusClass}">${maintenance.status}</span>
                            <small class="text-muted ms-2">${formattedDate}</small>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Category:</strong> ${maintenance.category}</p>
                                <p><strong>Description:</strong> ${maintenance.description}</p>
                                <p><strong>Target Accounts:</strong> ${maintenance.targetAccounts.join(', ')}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Start:</strong> ${startTime}</p>
                                <p><strong>End:</strong> ${endTime}</p>
                                <p><strong>Actual End:</strong> ${actualEndTime}</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer d-flex justify-content-end">
                        <button class="btn btn-sm btn-info me-2" onclick="viewMaintenanceDetails(${maintenance.id})">
                            <i class="fas fa-eye"></i> Details
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="editMaintenanceForm(${maintenance.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                </div>
            </div>
        `;

        historyDiv.innerHTML += cardHtml;
    });
}
// Render pagination controls
        function renderPagination() {
            const paginationDiv = document.getElementById('pagination');
            const totalPages = Math.ceil(totalMaintenanceItems / itemsPerPage);

            let paginationHtml = '';

            if (currentPage > 1) {
                paginationHtml += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="loadMaintenanceHistory(${currentPage - 1})">Previous</a>
                    </li>
                `;
            }

            for (let i = 1; i <= totalPages; i++) {
                paginationHtml += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadMaintenanceHistory(${i})">${i}</a>
                    </li>
                `;
            }

            if (currentPage < totalPages) {
                paginationHtml += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="loadMaintenanceHistory(${currentPage + 1})">Next</a>
                    </li>
                `;
            }

            paginationDiv.innerHTML = paginationHtml;
        }

        // Submit maintenance form (create or update)
        function submitMaintenanceForm(event) {
            event.preventDefault();

            submitLoader.classList.remove('d-none');
            submitMaintenanceBtn.disabled = true;

            const maintenanceId = document.getElementById('maintenanceId').value;
            const method = 'POST';
            const url = `${apiURL}/system/client/system_maintenance`;

            // Get form values

            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const date = document.getElementById('date').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const targetAccounts = document.getElementById('targetAccounts').value;
            const category = document.getElementById('category').value;
            const status = document.getElementById('status').value;

            // Prepare target accounts array
            const accountsArray = targetAccounts === '*' ? ['*'] :
                                targetAccounts.split(',').map(acc => acc.trim()).filter(acc => acc);

            // Prepare request body
            const requestBody = {
                ...(maintenanceId ? { id: maintenanceId } : {}), // ⬅️ this skips `id` if not present
                title,
                description,
                date,
                startTime: `${date}T${startTime}:00Z`,
                endTime: `${date}T${endTime}:00Z`,
                targetAccounts: accountsArray,
                category,
                status
            };

            // If this is an update, add the actualEndTime if it's being completed
            if (maintenanceId && status === 'Completed') {
                requestBody.actualEndTime = new Date().toISOString();
            }

            fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${cognitoToken}`,
                    'x-origin-ip': originIP,
                    'x-otp': otp,
"x-compression": false,
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                alert('Maintenance ' + (maintenanceId ? 'updated' : 'created') + ' successfully!');
                resetMaintenanceForm();
                loadCurrentMaintenance();
                loadMaintenanceHistory(currentPage);
            })
            .catch(error => {
                alert('Error: ' + error.message);
                console.error('Error:', error);
            })
            .finally(() => {
                submitLoader.classList.add('d-none');
                submitMaintenanceBtn.disabled = false;
            });
        }

        // Reset maintenance form
        function resetMaintenanceForm() {
            document.getElementById('maintenanceForm').reset();
            document.getElementById('maintenanceId').value = '';
            document.querySelector('#maintenanceFormHeader h2').textContent = 'Schedule New Maintenance';

            // Set default date to today and time to next hour
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const nextHour = new Date(now.getTime() + 60 * 60 * 1000);
            const startTime = `${String(nextHour.getHours()).padStart(2, '0')}:${String(nextHour.getMinutes()).padStart(2, '0')}`;
            const endTime = `${String(nextHour.getHours() + 1).padStart(2, '0')}:${String(nextHour.getMinutes()).padStart(2, '0')}`;

            document.getElementById('date').value = today;
            document.getElementById('startTime').value = startTime;
            document.getElementById('endTime').value = endTime;
            document.getElementById('status').value = 'Scheduled';
        }

        // Edit maintenance - load data into form
        function editMaintenanceForm(maintenanceId) {
            fetch(`${apiURL}/system/maintenance/${maintenanceId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${cognitoToken}`,
                    'x-origin-ip': originIP,
                    'x-otp': otp,
"x-compression": false,
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.data) {
                    const maintenance = data.data;
                    document.querySelector('#maintenanceFormHeader h2').textContent = 'Edit Maintenance';


                    document.getElementById('maintenanceId').value = maintenance.id;
                    document.getElementById('title').value = maintenance.title;
                    document.getElementById('description').value = maintenance.description;

                    // Format date and times
                    const date = new Date(maintenance.date);
                    const formattedDate = date.toISOString().split('T')[0];
                    document.getElementById('date').value = formattedDate;

                    const startTime = new Date(maintenance.startTime);
                    const formattedStartTime = `${String(startTime.getHours()).padStart(2, '0')}:${String(startTime.getMinutes()).padStart(2, '0')}`;
                    document.getElementById('startTime').value = formattedStartTime;

                    const endTime = new Date(maintenance.endTime);
                    const formattedEndTime = `${String(endTime.getHours()).padStart(2, '0')}:${String(endTime.getMinutes()).padStart(2, '0')}`;
                    document.getElementById('endTime').value = formattedEndTime;

                    document.getElementById('targetAccounts').value = maintenance.targetAccounts.join(', ');
                    document.getElementById('category').value = maintenance.category;
                    document.getElementById('status').value = maintenance.status;

                    // Scroll to form
                    document.getElementById('maintenanceForm').scrollIntoView({ behavior: 'smooth' });
                }
            })
            .catch(error => {
                alert('Error loading maintenance details: ' + error.message);
                console.error('Error:', error);
            });
        }

        // View maintenance details in modal
        function viewMaintenanceDetails(maintenanceId) {
            fetch(`${apiURL}/system/maintenance/${maintenanceId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${cognitoToken}`,
                    'x-origin-ip': originIP,
                    'x-otp': otp,
"x-compression": false,
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.data) {
                    const maintenance = data.data;
                    const modal = new bootstrap.Modal(document.getElementById('maintenanceDetailsModal'));

                    const statusClass = maintenance.status === 'Scheduled' ? 'status-scheduled' :
                                      maintenance.status === 'Ongoing' ? 'status-ongoing' :
                                      maintenance.status === 'Completed' ? 'status-completed' : 'status-scheduled';

                    const startTime = new Date(maintenance.startTime).toLocaleString();
                    const endTime = new Date(maintenance.endTime).toLocaleString();
                    const actualEndTime = maintenance.actualEndTime ? new Date(maintenance.actualEndTime).toLocaleString() : 'N/A';
                    const formattedDate = new Date(maintenance.date).toLocaleDateString();
                    const createdAt = new Date(maintenance.createdAt).toLocaleString();
                    const updatedAt = new Date(maintenance.updatedAt).toLocaleString();

                    const detailsHtml = `
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Title:</strong> ${maintenance.title}</p>
                                <p><strong>Category:</strong> ${maintenance.category}</p>
                                <p><strong>Status:</strong> <span class="${statusClass}">${maintenance.status}</span></p>
                                <p><strong>Date:</strong> ${formattedDate}</p>
                                <p><strong>Start Time:</strong> ${startTime}</p>
                                <p><strong>End Time:</strong> ${endTime}</p>
                                <p><strong>Actual End Time:</strong> ${actualEndTime}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Description:</strong></p>
                                <p>${maintenance.description}</p>
                                <p><strong>Target Accounts:</strong> ${maintenance.targetAccounts.join(', ')}</p>
                                <hr>
                                <p><strong>Created At:</strong> ${createdAt}</p>
                                <p><strong>Updated At:</strong> ${updatedAt}</p>
                            </div>
                        </div>
                    `;

                    document.getElementById('maintenanceDetailsContent').innerHTML = detailsHtml;
                    document.getElementById('maintenanceDetailsModalLabel').textContent = `Maintenance: ${maintenance.title}`;
                    document.getElementById('editMaintenanceBtn').setAttribute('data-id', maintenance.id);

                    modal.show();
                }
            })
            .catch(error => {
                alert('Error loading maintenance details: ' + error.message);
                console.error('Error:', error);
            });
        }

        // Complete ongoing maintenance
        function completeMaintenance(maintenanceId) {
            if (confirm('Are you sure you want to mark this maintenance as completed?')) {
                fetch(`${apiURL}/system/maintenance`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${cognitoToken}`,
                        'x-origin-ip': originIP,
                        'x-otp': otp,
"x-compression": false,
                    },
                    body: JSON.stringify({
                        status: 'Completed',
                        id: maintenanceId,
                        actualEndTime: new Date().toISOString()
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    alert('Maintenance marked as completed successfully!');
                    loadCurrentMaintenance();
                    loadMaintenanceHistory(currentPage);
                })
                .catch(error => {
                    alert('Error completing maintenance: ' + error.message);
                    console.error('Error:', error);
                });
            }
        }

        // Edit maintenance from modal
        function editMaintenance() {
            const maintenanceId = document.getElementById('editMaintenanceBtn').getAttribute('data-id');
            const modal = bootstrap.Modal.getInstance(document.getElementById('maintenanceDetailsModal'));

            modal.hide();
            editMaintenanceForm(maintenanceId);
        }
</script>
</body>

</html>