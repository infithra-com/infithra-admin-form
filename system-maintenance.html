<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="https://infithra.com/assets/favicon.ico" sizes="16x16">
    <title>System Maintenance</title>
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1112.0.min.js"></script>
    <!-- Include Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/script.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.15/dist/amazon-cognito-identity.min.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --success-color: #4cc9f0;
            --warning-color: #f72585;
            --light-bg: #f8f9fa;
        }

        .maintenance-card {
            border-left: 4px solid var(--primary-color);
            transition: all 0.3s ease;
            border-radius: 8px;
        }

        .maintenance-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .maintenance-card.ongoing {
            border-left-color: var(--accent-color);
        }

        .maintenance-card.completed {
            border-left-color: var(--success-color);
        }

        .maintenance-card.cancelled {
            border-left-color: var(--warning-color);
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-scheduled {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-ongoing {
            background-color: #cce5ff;
            color: #004085;
        }

        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }

        .status-cancelled {
            background-color: #f8d7da;
            color: #721c24;
        }

        .impact-high {
            background-color: #fee2e2;
            color: #b91c1c;
        }

        .impact-medium {
            background-color: #fef3c7;
            color: #b45309;
        }

        .impact-low {
            background-color: #ecfccb;
            color: #4d7c0f;
        }

        .form-step {
            display: none;
        }

        .form-step.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .loader {
            display: none;
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body class="bg-body-secondary">
    <!-- Keep the original header/navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-md mb-4">
        <div class="container">
            <a class="navbar-brand font-bold text-xl" href="/">
              <img width="135px" src="https://infithra.com/assets/images/infinthra-bluetext-logo.webp" alt="infothra-logo">
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link text-lg hover:text-blue-600" href="company.html">Company Information</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-lg hover:text-blue-600" href="system-control.html">System Control</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-lg hover:text-blue-600 active" href="system-maintenance.html">System Maintenance</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-lg hover:text-blue-600" href="old-maintenance.html">Old System Maintenance</a>
                    </li>
                    <button class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-200 ease-in-out cursor-pointer" onclick="logout()">Logout</a>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Updated Content Section -->
    <div class="container mx-auto px-4 py-6">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">
                <i class="fas fa-tools mr-3 text-blue-600"></i>
                System Maintenance
            </h1>
            <button id="newMaintenanceBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg shadow transition duration-200" onclick="resetMaintenanceForm()">
                <i class="fas fa-plus-circle mr-2"></i> Schedule Maintenance
            </button>
        </div>

        <!-- Current Maintenance Section -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                    Active Maintenance
                </h2>
                <button class="text-blue-600 hover:text-blue-800 text-sm" onclick="loadCurrentMaintenance()">
                    <i class="fas fa-sync-alt mr-1"></i> Refresh
                </button>
            </div>

            <div id="currentMaintenance">
                <div class="text-center py-8">
                    <div class="loader mx-auto" id="currentLoader"></div>
                    <p class="text-gray-500 mt-4" id="currentMessage">Loading active maintenance...</p>
                </div>
            </div>
        </div>

        <!-- Maintenance History Section -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-6 gap-4">
                <h2 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-history text-gray-600 mr-2"></i>
                    Maintenance History
                </h2>
                <div class="flex flex-col md:flex-row gap-3">
                    <div class="relative flex-1">
                        <input type="text" id="historytargetAccountsFilter" class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="Filter by accounts">
                        <i class="fas fa-users absolute left-3 top-3 text-gray-400"></i>
                    </div>
                    <input type="date" id="historydateFilter" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                    <select id="historyStatusFilter" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                        <option value="">All Statuses</option>
                        <option value="Scheduled">Scheduled</option>
                        <option value="Ongoing">Ongoing</option>
                        <option value="Completed">Completed</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                    <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow transition duration-200" onclick="loadMaintenanceHistory()">
                        <i class="fas fa-filter mr-2"></i> Filter
                    </button>
                </div>
            </div>

            <div id="maintenanceHistory">
                <div class="text-center py-8">
                    <div class="loader mx-auto" id="historyLoader"></div>
                    <p class="text-gray-500 mt-4" id="historyMessage">Loading maintenance history...</p>
                </div>
            </div>

            <div class="flex justify-center mt-6">
                <nav aria-label="Page navigation">
                    <ul class="pagination flex space-x-2" id="pagination">
                        <!-- Pagination will be added here by JavaScript -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Maintenance Form Modal -->
    <div class="modal fade" id="maintenanceFormModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title font-semibold text-lg" id="maintenanceFormModalLabel">Schedule New Maintenance</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body px-6 py-4">
                    <!-- Step Progress -->
                    <div class="flex justify-between mb-8 relative">
                        <div class="absolute top-1/2 left-0 right-0 h-1 bg-gray-200 -z-10"></div>
                        <div class="step flex flex-col items-center relative" id="step1">
                            <div class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center mb-2">1</div>
                            <span class="text-sm font-medium text-blue-600">Details</span>
                        </div>
                        <div class="step flex flex-col items-center relative" id="step2">
                            <div class="w-10 h-10 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center mb-2">2</div>
                            <span class="text-sm font-medium text-gray-600">Timing</span>
                        </div>
                        <div class="step flex flex-col items-center relative" id="step3">
                            <div class="w-10 h-10 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center mb-2">3</div>
                            <span class="text-sm font-medium text-gray-600">Impact</span>
                        </div>
                        <div class="step flex flex-col items-center relative" id="step4">
                            <div class="w-10 h-10 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center mb-2">4</div>
                            <span class="text-sm font-medium text-gray-600">Review</span>
                        </div>
                    </div>

                    <form id="maintenanceForm" onsubmit="submitMaintenanceForm(event)">
                        <input type="hidden" id="maintenanceId">

                        <!-- Step 1: Maintenance Details -->
                        <div class="form-step active" id="formStep1">
                            <div class="mb-4">
                                <label for="title" class="block text-gray-700 font-medium mb-2">Title *</label>
                                <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500" id="title" placeholder="e.g. Database Upgrade" required>
                            </div>

                            <div class="mb-4">
                                <label for="category" class="block text-gray-700 font-medium mb-2">Category *</label>
                                <select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500" id="category" required>
                                    <option value="">Select Category</option>
                                    <option value="System Upgrade">System Upgrade</option>
                                    <option value="Server Maintenance">Server Maintenance</option>
                                    <option value="Database Maintenance">Database Maintenance</option>
                                    <option value="Network Maintenance">Network Maintenance</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>

                            <div class="mb-4">
                                <label for="description" class="block text-gray-700 font-medium mb-2">Description *</label>
                                <textarea class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500" id="description" rows="3" placeholder="Describe the maintenance work to be performed..." required></textarea>
                            </div>

                            <div class="flex justify-end mt-6">
                                <button type="button" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg shadow transition duration-200" onclick="nextStep(2)">Next <i class="fas fa-arrow-right ml-2"></i></button>
                            </div>
                        </div>

                        <!-- Step 2: Timing -->
                        <div class="form-step" id="formStep2">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="mb-4">
                                    <label for="date" class="block text-gray-700 font-medium mb-2">Date *</label>
                                    <input type="date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500" id="date" required>
                                </div>

                                <div class="mb-4">
                                    <label for="status" class="block text-gray-700 font-medium mb-2">Status *</label>
                                    <select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500" id="status" required>
                                        <option value="Scheduled">Scheduled</option>
                                        <option value="Ongoing">Ongoing</option>
                                        <option value="Completed">Completed</option>
                                        <option value="Cancelled">Cancelled</option>
                                    </select>
                                </div>

                                <div class="mb-4">
                                    <label for="startTime" class="block text-gray-700 font-medium mb-2">Start Time (UTC) *</label>
                                    <input type="time" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500" id="startTime" required>
                                </div>

                                <div class="mb-4">
                                    <label for="endTime" class="block text-gray-700 font-medium mb-2">End Time (UTC) *</label>
                                    <input type="time" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500" id="endTime" required>
                                </div>
                            </div>

                            <div class="flex justify-between mt-6">
                                <button type="button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg shadow transition duration-200" onclick="prevStep(1)">
                                    <i class="fas fa-arrow-left mr-2"></i> Back
                                </button>
                                <button type="button" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg shadow transition duration-200" onclick="nextStep(3)">
                                    Next <i class="fas fa-arrow-right ml-2"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Step 3: Impact -->
                        <div class="form-step" id="formStep3">
                            <!-- <div class="mb-4">
                                <label for="targetAccounts" class="block text-gray-700 font-medium mb-2">Affected Accounts *</label>
                                <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500" id="targetAccounts" placeholder="6666666,5555555 or * for all" required>
                                <p class="text-sm text-gray-500 mt-1">Enter account numbers separated by commas or * for all accounts</p>
                            </div> -->
                            <div class="mb-4">
                                <label for="targetAccounts" class="block text-gray-700 font-medium mb-2">Affected Accounts *</label>
                                <select multiple class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500" id="targetAccounts" required>
                                    <!-- Options will be populated by JavaScript -->
                                </select>
                                <p class="text-sm text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple accounts</p>
                            </div>

                            <div class="mb-4">
                                <label class="block text-gray-700 font-medium mb-2">Expected Impact</label>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="impact-high p-4 rounded-lg cursor-pointer" onclick="setImpact('High')">
                                        <h4 class="font-semibold mb-2">High Impact</h4>
                                        <p class="text-sm">System downtime expected. All users will be affected.</p>
                                    </div>
                                    <div class="impact-medium p-4 rounded-lg cursor-pointer" onclick="setImpact('Medium')">
                                        <h4 class="font-semibold mb-2">Medium Impact</h4>
                                        <p class="text-sm">Partial functionality affected. Some users may experience issues.</p>
                                    </div>
                                    <div class="impact-low p-4 rounded-lg cursor-pointer" onclick="setImpact('Low')">
                                        <h4 class="font-semibold mb-2">Low Impact</h4>
                                        <p class="text-sm">Minimal impact. Most users won't notice any changes.</p>
                                    </div>
                                </div>
                                <input type="hidden" id="impactLevel">
                            </div>

                            <div class="flex justify-between mt-6">
                                <button type="button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg shadow transition duration-200" onclick="prevStep(2)">
                                    <i class="fas fa-arrow-left mr-2"></i> Back
                                </button>
                                <button type="button" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg shadow transition duration-200" onclick="nextStep(4)">
                                    Next <i class="fas fa-arrow-right ml-2"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Step 4: Review -->
                        <div class="form-step" id="formStep4">
                            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                <h4 class="font-semibold text-gray-800 mb-3">Maintenance Summary</h4>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <p class="text-sm text-gray-600">Title:</p>
                                        <p class="font-medium" id="reviewTitle"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Category:</p>
                                        <p class="font-medium" id="reviewCategory"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Status:</p>
                                        <p class="font-medium" id="reviewStatus"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Impact Level:</p>
                                        <p class="font-medium" id="reviewImpact"></p>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <p class="text-sm text-gray-600">Description:</p>
                                    <p class="font-medium" id="reviewDescription"></p>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-600">Date:</p>
                                        <p class="font-medium" id="reviewDate"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Start Time (UTC):</p>
                                        <p class="font-medium" id="reviewStartTime"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">End Time (UTC):</p>
                                        <p class="font-medium" id="reviewEndTime"></p>
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <p class="text-sm text-gray-600">Affected Accounts:</p>
                                    <p class="font-medium" id="reviewTargetAccounts"></p>
                                </div>
                            </div>

                            <div class="flex justify-between mt-6">
                                <button type="button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg shadow transition duration-200" onclick="prevStep(3)">
                                    <i class="fas fa-arrow-left mr-2"></i> Back
                                </button>
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg shadow transition duration-200" id="submitMaintenanceBtn">
                                    <span id="submitLoader" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                    Submit Maintenance
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Maintenance Details Modal -->
    <div class="modal fade" id="maintenanceDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title font-semibold text-lg" id="maintenanceDetailsModalLabel">Maintenance Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body px-6 py-4" id="maintenanceDetailsContent">
                    <!-- Content will be loaded here -->
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg shadow transition duration-200" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow transition duration-200" id="editMaintenanceBtn" onclick="editMaintenance()">
                        <i class="fas fa-edit mr-2"></i> Edit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentPage = 1;
        const itemsPerPage = 5;
        let totalMaintenanceItems = 0;

        // DOM elements
        const currentLoader = document.getElementById('currentLoader');
        const currentMessage = document.getElementById('currentMessage');
        const submitLoader = document.getElementById('submitLoader');
        const submitMaintenanceBtn = document.getElementById('submitMaintenanceBtn');
        const historyLoader = document.getElementById('historyLoader');
        const historyMessage = document.getElementById('historyMessage');

        // Form wizard functions
        function nextStep(step) {
            // Validate current step before proceeding
            if (step === 2 && !validateStep1()) return;
            if (step === 3 && !validateStep2()) return;
            if (step === 4 && !validateStep3()) return;

            // Hide all steps
            document.querySelectorAll('.form-step').forEach(el => {
                el.classList.remove('active');
            });

            // Show the selected step
            document.getElementById(`formStep${step}`).classList.add('active');

            // Update step progress
            document.querySelectorAll('.step').forEach(el => {
                el.querySelector('div').classList.remove('bg-blue-600', 'text-white');
                el.querySelector('span').classList.remove('text-blue-600', 'font-medium');
                el.querySelector('div').classList.add('bg-gray-200', 'text-gray-600');
                el.querySelector('span').classList.add('text-gray-600');
            });

            for (let i = 1; i <= step; i++) {
                const stepEl = document.getElementById(`step${i}`);
                stepEl.querySelector('div').classList.remove('bg-gray-200', 'text-gray-600');
                stepEl.querySelector('div').classList.add('bg-blue-600', 'text-white');
                stepEl.querySelector('span').classList.remove('text-gray-600');
                stepEl.querySelector('span').classList.add('text-blue-600', 'font-medium');
            }

            // If this is the review step, populate the review fields
            if (step === 4) {
                populateReviewStep();
            }
        }

        function prevStep(step) {
            // Hide all steps
            document.querySelectorAll('.form-step').forEach(el => {
                el.classList.remove('active');
            });

            // Show the selected step
            document.getElementById(`formStep${step}`).classList.add('active');

            // Update step progress
            document.querySelectorAll('.step').forEach(el => {
                el.querySelector('div').classList.remove('bg-blue-600', 'text-white');
                el.querySelector('span').classList.remove('text-blue-600', 'font-medium');
                el.querySelector('div').classList.add('bg-gray-200', 'text-gray-600');
                el.querySelector('span').classList.add('text-gray-600');
            });

            for (let i = 1; i <= step; i++) {
                const stepEl = document.getElementById(`step${i}`);
                stepEl.querySelector('div').classList.remove('bg-gray-200', 'text-gray-600');
                stepEl.querySelector('div').classList.add('bg-blue-600', 'text-white');
                stepEl.querySelector('span').classList.remove('text-gray-600');
                stepEl.querySelector('span').classList.add('text-blue-600', 'font-medium');
            }
        }

        function validateStep1() {
            const title = document.getElementById('title').value;
            const category = document.getElementById('category').value;
            const description = document.getElementById('description').value;

            if (!title || !category || !description) {
                alert('Please fill in all required fields in the Details section.');
                return false;
            }

            return true;
        }

        function validateStep2() {
            const date = document.getElementById('date').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;

            if (!date || !startTime || !endTime) {
                alert('Please fill in all required fields in the Timing section.');
                return false;
            }

            // Validate that end time is after start time
            const startDateTime = new Date(`${date}T${startTime}`);
            const endDateTime = new Date(`${date}T${endTime}`);

            if (endDateTime <= startDateTime) {
                alert('End time must be after start time.');
                return false;
            }

            return true;
        }

        function validateStep3() {
            const targetAccounts = document.getElementById('targetAccounts').value;

            if (!targetAccounts) {
                alert('Please specify which accounts will be affected by this maintenance.');
                return false;
            }

            return true;
        }

        function setImpact(level) {
            document.getElementById('impactLevel').value = level;

            // Update UI to show selected impact
            document.querySelectorAll('.impact-high, .impact-medium, .impact-low').forEach(el => {
                el.classList.remove('ring-2', 'ring-blue-500');
            });

            event.currentTarget.classList.add('ring-2', 'ring-blue-500');
        }

        function populateReviewStep() {
            document.getElementById('reviewTitle').textContent = document.getElementById('title').value;
            document.getElementById('reviewCategory').textContent = document.getElementById('category').value;
            document.getElementById('reviewStatus').textContent = document.getElementById('status').value;
            document.getElementById('reviewDescription').textContent = document.getElementById('description').value;
            document.getElementById('reviewDate').textContent = document.getElementById('date').value;
            document.getElementById('reviewStartTime').textContent = document.getElementById('startTime').value;
            document.getElementById('reviewEndTime').textContent = document.getElementById('endTime').value;
            //document.getElementById('reviewTargetAccounts').textContent = document.getElementById('targetAccounts').value;
            const accountSelect = document.getElementById('targetAccounts');
            const selectedAccounts = Array.from(accountSelect.selectedOptions)
                .map(option => option.text);

            document.getElementById('reviewTargetAccounts').textContent =
                selectedAccounts.join(', ');
                    document.getElementById('reviewImpact').textContent = document.getElementById('impactLevel').value || 'Not specified';
                }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date to today and time to next hour
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const nextHour = new Date(now.getTime());
            const startTime = `${String(nextHour.getHours()).padStart(2, '0')}:${String(nextHour.getMinutes()).padStart(2, '0')}`;
            const endTime = `${String(nextHour.getHours() + 1).padStart(2, '0')}:${String(nextHour.getMinutes()).padStart(2, '0')}`;

            document.getElementById('date').value = today;
            document.getElementById('startTime').value = startTime;
            document.getElementById('endTime').value = endTime;

            // Load initial data
            loadCurrentMaintenance();
            loadMaintenanceHistory();
            populateMaintenanceAccountDropdown();
        });

        // Load current maintenance (Scheduled or Ongoing)
        function loadCurrentMaintenance() {
            console.log('Loading current maintenance...');
            currentLoader.style.display = 'block';
            currentMessage.textContent = 'Loading current maintenance...';
            document.getElementById('currentMaintenance').innerHTML = '';

            fetch(`${apiManintenanceURL}/api/maintenance?accounts=*`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${cognitoToken}`,
                    'x-origin-ip': originIP,
                    'x-otp': otp,
                    "x-compression": false,
                    "x-environment" : sessionStorage.getItem('selectedEnv') ? sessionStorage.getItem('selectedEnv') : 'local'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                currentLoader.style.display = 'none';

                if (data.data) {
                    currentMessage.textContent = '';
                    renderCurrentMaintenance(data.data);
                } else {
                    currentMessage.textContent = 'No active maintenance scheduled.';
                }
            })
            .catch(error => {
                currentLoader.style.display = 'none';
                currentMessage.textContent = 'Error loading current maintenance.';
                console.error('Error:', error);
            });
        }

        // Render current maintenance card
        function renderCurrentMaintenance(maintenance) {
            const currentMaintenanceDiv = document.getElementById('currentMaintenance');

            const statusClass = maintenance.status === 'Scheduled' ? 'status-scheduled' :
                              maintenance.status === 'Ongoing' ? 'status-ongoing' :
                              maintenance.status === 'Completed' ? 'status-completed' : 'status-cancelled';

            const startTime = new Date(maintenance.startTime).toLocaleString();
            const endTime = new Date(maintenance.endTime).toLocaleString();
            const formattedDate = new Date(maintenance.date).toLocaleDateString();

            const cardHtml = `
                <div class="maintenance-card ${maintenance.status.toLowerCase()} p-4 mb-4">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">${maintenance.title}</h3>
                            <div class="flex items-center mt-1">
                                <span class="${statusClass} status-badge mr-3">${maintenance.status}</span>
                                <span class="text-sm text-gray-600"><i class="fas fa-calendar-day mr-1"></i> ${formattedDate}</span>
                            </div>
                        </div>
                        <span class="text-sm bg-blue-100 text-blue-800 px-3 py-1 rounded-full">${maintenance.category}</span>
                    </div>

                    <p class="text-gray-600 mb-4">${maintenance.description}</p>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-500">Start Time</p>
                            <p class="font-medium">${startTime}</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-500">End Time</p>
                            <p class="font-medium">${endTime}</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-500">Affected Accounts</p>
                            <p class="font-medium">${maintenance.targetAccounts.join(', ')}</p>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-2">
                        <button class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded-lg text-sm" onclick="viewMaintenanceDetails('${maintenance.id}')">
                            <i class="fas fa-eye mr-1"></i> Details
                        </button>
                        <button class="bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-1 rounded-lg text-sm" onclick="editMaintenanceForm('${maintenance.id}')">
                            <i class="fas fa-edit mr-1"></i> Edit
                        </button>
                        ${(maintenance.status === 'Ongoing' || maintenance.status === 'Scheduled') ? `
                            <button class="bg-green-100 hover:bg-green-200 text-green-800 px-3 py-1 rounded-lg text-sm" onclick="completeMaintenance('${maintenance.id}')">
                                <i class="fas fa-check-circle mr-1"></i> Complete
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;

            currentMaintenanceDiv.innerHTML = cardHtml;
        }

        // Load maintenance history with pagination
        function loadMaintenanceHistory(page = 1) {
            currentPage = page;
            historyLoader.style.display = 'block';
            historyMessage.textContent = 'Loading maintenance history...';
            document.getElementById('maintenanceHistory').innerHTML = '';
            document.getElementById('pagination').innerHTML = '';

            // Get filter values
            const accountsFilter = document.getElementById('historytargetAccountsFilter').value;
            const dateFilter = document.getElementById('historydateFilter').value;
            const statusFilter = document.getElementById('historyStatusFilter').value;

            // Build query parameters
            let queryParams = `page=${page}&limit=${itemsPerPage}`;

            if (accountsFilter) {
                queryParams += `&accounts=${encodeURIComponent(accountsFilter)}`;
            }

            if (dateFilter) {
                queryParams += `&date=${encodeURIComponent(dateFilter)}`;
            }

            if (statusFilter) {
                queryParams += `&status=${encodeURIComponent(statusFilter)}`;
            }

            fetch(`${apiManintenanceURL}/api/maintenance/history?${queryParams}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${cognitoToken}`,
                    'x-origin-ip': originIP,
                    'x-otp': otp,
                    "x-compression": false,
                    "x-environment" : sessionStorage.getItem('selectedEnv') ? sessionStorage.getItem('selectedEnv') : 'local'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                historyLoader.style.display = 'none';

                if (data.data && data.data.length > 0) {
                    historyMessage.textContent = '';
                    totalMaintenanceItems = data.total || data.data.length;
                    renderMaintenanceHistory(data.data);
                    renderPagination();
                } else {
                    historyMessage.textContent = 'No maintenance history found.';
                }
            })
            .catch(error => {
                historyLoader.style.display = 'none';
                historyMessage.textContent = 'Error loading maintenance history.';
                console.error('Error:', error);
            });
        }

        // Render maintenance history cards
        function renderMaintenanceHistory(maintenanceList) {
            const historyDiv = document.getElementById('maintenanceHistory');

            maintenanceList.forEach(maintenance => {
                const statusClass = maintenance.status === 'Scheduled' ? 'status-scheduled' :
                                  maintenance.status === 'Ongoing' ? 'status-ongoing' :
                                  maintenance.status === 'Completed' ? 'status-completed' : 'status-cancelled';

                const startTime = new Date(maintenance.startTime).toLocaleString();
                const endTime = new Date(maintenance.endTime).toLocaleString();
                const actualEndTime = maintenance.actualEndTime ? new Date(maintenance.actualEndTime).toLocaleString() : 'N/A';
                const formattedDate = new Date(maintenance.date).toLocaleDateString();

                const cardHtml = `
                    <div class="maintenance-card ${maintenance.status.toLowerCase()} p-4 mb-4">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-semibold text-gray-800">${maintenance.title}</h4>
                                <div class="flex items-center mt-1">
                                    <span class="${statusClass} status-badge mr-3">${maintenance.status}</span>
                                    <span class="text-sm text-gray-600"><i class="fas fa-calendar-day mr-1"></i> ${formattedDate}</span>
                                </div>
                            </div>
                            <span class="text-sm bg-blue-100 text-blue-800 px-3 py-1 rounded-full">${maintenance.category}</span>
                        </div>

                        <p class="text-gray-600 text-sm mb-3">${maintenance.description}</p>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                            <div class="bg-gray-50 p-2 rounded-lg">
                                <p class="text-xs text-gray-500">Start</p>
                                <p class="text-sm font-medium">${startTime}</p>
                            </div>
                            <div class="bg-gray-50 p-2 rounded-lg">
                                <p class="text-xs text-gray-500">End</p>
                                <p class="text-sm font-medium">${endTime}</p>
                            </div>
                            <div class="bg-gray-50 p-2 rounded-lg">
                                <p class="text-xs text-gray-500">Actual End</p>
                                <p class="text-sm font-medium">${actualEndTime}</p>
                            </div>
                        </div>

                        <div class="flex justify-end space-x-2">
                            <button class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded-lg text-sm" onclick="viewMaintenanceDetails('${maintenance.id}')">
                                <i class="fas fa-eye mr-1"></i> Details
                            </button>
                            <button class="bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-1 rounded-lg text-sm" onclick="editMaintenanceForm('${maintenance.id}')">
                                <i class="fas fa-edit mr-1"></i> Edit
                            </button>
                        </div>
                    </div>
                `;

                historyDiv.innerHTML += cardHtml;
            });
        }

        // Render pagination controls
        function renderPagination() {
            const paginationDiv = document.getElementById('pagination');
            const totalPages = Math.ceil(totalMaintenanceItems / itemsPerPage);

            let paginationHtml = '';

            if (currentPage > 1) {
                paginationHtml += `
                    <li class="page-item">
                        <a class="page-link px-3 py-1 border rounded-l-lg" href="#" onclick="loadMaintenanceHistory(${currentPage - 1})">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                `;
            }

            // Show first page
            if (currentPage > 3) {
                paginationHtml += `
                    <li class="page-item">
                        <a class="page-link px-3 py-1 border" href="#" onclick="loadMaintenanceHistory(1)">1</a>
                    </li>
                `;
                if (currentPage > 4) {
                    paginationHtml += `<li class="page-item px-3 py-1 border">...</li>`;
                }
            }

            // Show pages around current page
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                paginationHtml += `
                    <li class="page-item ${i === currentPage ? 'bg-blue-50' : ''}">
                        <a class="page-link px-3 py-1 border ${i === currentPage ? 'text-blue-600 font-semibold' : ''}" href="#" onclick="loadMaintenanceHistory(${i})">${i}</a>
                    </li>
                `;
            }

            // Show last page
            if (currentPage < totalPages - 2) {
                if (currentPage < totalPages - 3) {
                    paginationHtml += `<li class="page-item px-3 py-1 border">...</li>`;
                }
                paginationHtml += `
                    <li class="page-item">
                        <a class="page-link px-3 py-1 border" href="#" onclick="loadMaintenanceHistory(${totalPages})">${totalPages}</a>
                    </li>
                `;
            }

            if (currentPage < totalPages) {
                paginationHtml += `
                    <li class="page-item">
                        <a class="page-link px-3 py-1 border rounded-r-lg" href="#" onclick="loadMaintenanceHistory(${currentPage + 1})">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                `;
            }

            paginationDiv.innerHTML = paginationHtml;
        }

        // Submit maintenance form (create or update)
        function submitMaintenanceForm(event) {
            event.preventDefault();

            submitLoader.classList.remove('d-none');
            submitMaintenanceBtn.disabled = true;

            const maintenanceId = document.getElementById('maintenanceId').value;
            const method = 'POST';
            const url = `${apiManintenanceURL}/api/maintenance`;



            // Get form values
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const date = document.getElementById('date').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const category = document.getElementById('category').value;
            const status = document.getElementById('status').value;

            // Prepare target accounts array
            /* const accountsArray = targetAccounts === '*' ? ['*'] :
                                targetAccounts.split(',').map(acc => acc.trim()).filter(acc => acc); */

            const accountSelect = document.getElementById('targetAccounts');
            const selectedAccounts = Array.from(accountSelect.selectedOptions)
                .map(option => option.value);

            // Validate at least one account is selected
            if (selectedAccounts.length === 0) {
                alert('Please select at least one account');
                return;
            }

            // Prepare request body
            const requestBody = {
                ...(maintenanceId ? { id: maintenanceId } : {}),
                title,
                description,
                date,
                startTime: `${date}T${startTime}:00Z`,
                endTime: `${date}T${endTime}:00Z`,
                targetAccounts: selectedAccounts,
                category,
                status
            };

            // If this is an update, add the actualEndTime if it's being completed
            if (maintenanceId && status === 'Completed') {
                requestBody.actualEndTime = new Date().toISOString();
            }

            fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${cognitoToken}`,
                    'x-origin-ip': originIP,
                    'x-otp': otp,
                    "x-compression": false,
                    "x-environment" : sessionStorage.getItem('selectedEnv') ? sessionStorage.getItem('selectedEnv') : 'local'
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                alert('Maintenance ' + (maintenanceId ? 'updated' : 'created') + ' successfully!');
                resetMaintenanceForm();
                loadCurrentMaintenance();
                clearCache();
                loadMaintenanceHistory(currentPage);

                // Hide the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('maintenanceFormModal'));
                modal.hide();
            })
            .catch(error => {
                alert('Error: ' + error.message);
                console.error('Error:', error);
            })
            .finally(() => {
                submitLoader.classList.add('d-none');
                submitMaintenanceBtn.disabled = false;
            });
        }

        // Reset maintenance form
        function resetMaintenanceForm() {
            document.getElementById('maintenanceForm').reset();
            document.getElementById('maintenanceId').value = '';
            document.getElementById('maintenanceFormModalLabel').textContent = 'Schedule New Maintenance';

            // Set default date to today and time to next hour
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const nextHour = new Date(now.getTime());
            const startTime = `${String(nextHour.getHours()).padStart(2, '0')}:${String(nextHour.getMinutes()).padStart(2, '0')}`;
            const endTime = `${String(nextHour.getHours() + 1).padStart(2, '0')}:${String(nextHour.getMinutes()).padStart(2, '0')}`;

            document.getElementById('date').value = today;
            document.getElementById('startTime').value = startTime;
            document.getElementById('endTime').value = endTime;
            document.getElementById('status').value = 'Scheduled';

            // Reset form wizard to first step
            document.querySelectorAll('.form-step').forEach(el => {
                el.classList.remove('active');
            });
            document.getElementById('formStep1').classList.add('active');

            document.querySelectorAll('.step').forEach(el => {
                el.querySelector('div').classList.remove('bg-blue-600', 'text-white');
                el.querySelector('span').classList.remove('text-blue-600', 'font-medium');
                el.querySelector('div').classList.add('bg-gray-200', 'text-gray-600');
                el.querySelector('span').classList.add('text-gray-600');
            });

            document.getElementById('step1').querySelector('div').classList.remove('bg-gray-200', 'text-gray-600');
            document.getElementById('step1').querySelector('div').classList.add('bg-blue-600', 'text-white');
            document.getElementById('step1').querySelector('span').classList.remove('text-gray-600');
            document.getElementById('step1').querySelector('span').classList.add('text-blue-600', 'font-medium');

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('maintenanceFormModal'));
            modal.show();
        }

        // Edit maintenance - load data into form
        function editMaintenanceForm(maintenanceId) {
            fetch(`${apiManintenanceURL}/api/maintenance/${maintenanceId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${cognitoToken}`,
                    'x-origin-ip': originIP,
                    'x-otp': otp,
                    "x-compression": false,
                    "x-environment" : sessionStorage.getItem('selectedEnv') ? sessionStorage.getItem('selectedEnv') : 'local'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.data) {
                    const maintenance = data.data;

                     // First populate the dropdown
                    populateMaintenanceAccountDropdown().then(() => {
                        // Then select the accounts that were previously selected
                        const select = document.getElementById('targetAccounts');
                        maintenance.targetAccounts.forEach(accountId => {
                            const option = Array.from(select.options).find(
                                opt => opt.value === accountId.toString()
                            );
                            if (option) option.selected = true;
                        });
                    });
                    document.getElementById('maintenanceFormModalLabel').textContent = 'Edit Maintenance';

                    document.getElementById('maintenanceId').value = maintenance.id;
                    document.getElementById('title').value = maintenance.title;
                    document.getElementById('description').value = maintenance.description;

                    // Format date and times
                    const date = new Date(maintenance.date);
                    const formattedDate = date.toISOString().split('T')[0];
                    document.getElementById('date').value = formattedDate;

                    const startTime = new Date(maintenance.startTime);
                    const formattedStartTime = `${String(startTime.getHours()).padStart(2, '0')}:${String(startTime.getMinutes()).padStart(2, '0')}`;
                    document.getElementById('startTime').value = formattedStartTime;

                    const endTime = new Date(maintenance.endTime);
                    const formattedEndTime = `${String(endTime.getHours()).padStart(2, '0')}:${String(endTime.getMinutes()).padStart(2, '0')}`;
                    document.getElementById('endTime').value = formattedEndTime;

                   // document.getElementById('targetAccounts').value = maintenance.targetAccounts.join(', ');
                    document.getElementById('category').value = maintenance.category;
                    document.getElementById('status').value = maintenance.status;

                    // Show the modal and go to first step
                    const modal = new bootstrap.Modal(document.getElementById('maintenanceFormModal'));
                    modal.show();

                    // Reset form wizard to first step
                    document.querySelectorAll('.form-step').forEach(el => {
                        el.classList.remove('active');
                    });
                    document.getElementById('formStep1').classList.add('active');

                    document.querySelectorAll('.step').forEach(el => {
                        el.querySelector('div').classList.remove('bg-blue-600', 'text-white');
                        el.querySelector('span').classList.remove('text-blue-600', 'font-medium');
                        el.querySelector('div').classList.add('bg-gray-200', 'text-gray-600');
                        el.querySelector('span').classList.add('text-gray-600');
                    });

                    document.getElementById('step1').querySelector('div').classList.remove('bg-gray-200', 'text-gray-600');
                    document.getElementById('step1').querySelector('div').classList.add('bg-blue-600', 'text-white');
                    document.getElementById('step1').querySelector('span').classList.remove('text-gray-600');
                    document.getElementById('step1').querySelector('span').classList.add('text-blue-600', 'font-medium');
                }
                clearCache();
            })
            .catch(error => {
                alert('Error loading maintenance details: ' + error.message);
                console.error('Error:', error);
            });
        }

        // View maintenance details in modal
        function viewMaintenanceDetails(maintenanceId) {
            fetch(`${apiManintenanceURL}/api/maintenance/${maintenanceId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${cognitoToken}`,
                    'x-origin-ip': originIP,
                    'x-otp': otp,
                    "x-compression": false,
                    "x-environment" : sessionStorage.getItem('selectedEnv') ? sessionStorage.getItem('selectedEnv') : 'local'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.data) {
                    const maintenance = data.data;
                    const modal = new bootstrap.Modal(document.getElementById('maintenanceDetailsModal'));

                    const statusClass = maintenance.status === 'Scheduled' ? 'status-scheduled' :
                                      maintenance.status === 'Ongoing' ? 'status-ongoing' :
                                      maintenance.status === 'Completed' ? 'status-completed' : 'status-cancelled';

                    const startTime = new Date(maintenance.startTime).toLocaleString();
                    const endTime = new Date(maintenance.endTime).toLocaleString();
                    const actualEndTime = maintenance.actualEndTime ? new Date(maintenance.actualEndTime).toLocaleString() : 'N/A';
                    const formattedDate = new Date(maintenance.date).toLocaleDateString();
                    const createdAt = new Date(maintenance.createdAt).toLocaleString();
                    const updatedAt = new Date(maintenance.updatedAt).toLocaleString();

                    const detailsHtml = `
                        <div class="mb-4">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h4 class="text-lg font-semibold">${maintenance.title}</h4>
                                    <div class="flex items-center mt-1">
                                        <span class="${statusClass} status-badge mr-3">${maintenance.status}</span>
                                        <span class="text-sm text-gray-600">${maintenance.category}</span>
                                    </div>
                                </div>
                                <span class="text-sm text-gray-600">${formattedDate}</span>
                            </div>

                            <p class="text-gray-700 mb-4">${maintenance.description}</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <h5 class="font-medium text-gray-700 mb-2">Timing</h5>
                                <div class="space-y-2">
                                    <p><span class="text-sm text-gray-600">Start:</span> ${startTime}</p>
                                    <p><span class="text-sm text-gray-600">End:</span> ${endTime}</p>
                                    <p><span class="text-sm text-gray-600">Actual End:</span> ${actualEndTime}</p>
                                </div>
                            </div>

                            <div class="bg-gray-50 p-3 rounded-lg">
                                <h5 class="font-medium text-gray-700 mb-2">Affected Accounts</h5>
                                <p>${maintenance.targetAccounts.join(', ')}</p>
                            </div>
                        </div>

                        <div class="bg-gray-50 p-3 rounded-lg">
                            <h5 class="font-medium text-gray-700 mb-2">System Information</h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <p><span class="text-sm text-gray-600">Created At:</span> ${createdAt}</p>
                                <p><span class="text-sm text-gray-600">Updated At:</span> ${updatedAt}</p>
                            </div>
                        </div>
                    `;

                    document.getElementById('maintenanceDetailsContent').innerHTML = detailsHtml;
                    document.getElementById('maintenanceDetailsModalLabel').textContent = `Maintenance: ${maintenance.title}`;
                    document.getElementById('editMaintenanceBtn').setAttribute('data-id', maintenance.id);

                    modal.show();
                }
            })
            .catch(error => {
                alert('Error loading maintenance details: ' + error.message);
                console.error('Error:', error);
            });
        }

        // Complete ongoing maintenance
        function completeMaintenance(maintenanceId) {
            if (confirm('Are you sure you want to mark this maintenance as completed?')) {
                fetch(`${apiManintenanceURL}/api/maintenance`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${cognitoToken}`,
                        'x-origin-ip': originIP,
                        'x-otp': otp,
                        "x-compression": false,
                        "x-environment" : sessionStorage.getItem('selectedEnv') ? sessionStorage.getItem('selectedEnv') : 'local'
                    },
                    body: JSON.stringify({
                        status: 'Completed',
                        id: maintenanceId,
                        actualEndTime: new Date().toISOString()
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    alert('Maintenance marked as completed successfully!');
                    clearCache();
                    loadCurrentMaintenance();
                    loadMaintenanceHistory(currentPage);
                })
                .catch(error => {
                    alert('Error completing maintenance: ' + error.message);
                    console.error('Error:', error);
                });
            }
        }

        // Edit maintenance from modal
        function editMaintenance() {
            const maintenanceId = document.getElementById('editMaintenanceBtn').getAttribute('data-id');
            const modal = bootstrap.Modal.getInstance(document.getElementById('maintenanceDetailsModal'));

            modal.hide();
            editMaintenanceForm(maintenanceId);
        }

        async function clearCache() {
            console.log('Clearing Cache');
            try {
                const response = await fetch(`${apiURL}/system/cache/clear`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${cognitoToken}`,
                        'x-origin-ip': originIP,
                        'x-otp': otp,
                        'x-compression': false
                    }
                });
                if (!response.ok) throw new Error('Failed to reset cache');
                console.log('Cache reset successfully');
            } catch (error) {
                console.error('Error clearing cache:', error);
            }
        }
        function populateMaintenanceAccountDropdown() {

                const select = document.querySelector('#targetAccounts');
                select.innerHTML = '<option value="" disabled>Loading accounts...</option>';

                return fetch(`${apiURL}/system/client/accounts`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${cognitoToken}`,
                        'x-origin-ip': originIP,
                        'x-otp': otp,
                        "x-compression": false,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    const select = document.querySelector('#targetAccounts');
                    select.innerHTML = ''; // Clear existing options

                    // Add individual accounts
                    data.data.forEach(account => {
                        const option = document.createElement('option');
                        option.value = account.accountId;
                        option.text = `${account.accountId} : ${account.name}`;
                        select.appendChild(option);
                    });

                    return data; // Return data for chaining
                })
                .catch(error => {
                    console.error('Error fetching accounts:', error);
                    throw error;
                });
}
    </script>
</body>
</html>